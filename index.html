<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>VRDControl - Suivi de Chantier</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --primary: #0f172a;
            --primary-light: #1e293b;
            --accent: #f97316;
            --accent-dark: #ea580c;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(15, 23, 42, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Barlow', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text);
            min-height: 100vh;
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 360px;
            background: var(--card);
            border-right: 2px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 24px var(--shadow);
            position: relative;
            z-index: 1000;
        }

        .header {
            padding: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-bottom: 3px solid var(--accent);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .version {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            padding: 3px 8px;
            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: rgba(255,255,255,0.95);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-family: 'JetBrains Mono', monospace;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 13px;
            opacity: 0.8;
            font-family: 'JetBrains Mono', monospace;
        }

        .project-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-family: 'Barlow', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--accent);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .project-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-card:hover {
            border-color: var(--accent);
            transform: translateX(4px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .project-card.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, #fff7ed 0%, white 100%);
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.2);
        }

        .project-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 8px;
            color: var(--text);
        }

        .project-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .project-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-todo { background: #fef3c7; color: #92400e; }
        .badge-progress { background: #dbeafe; color: #1e40af; }
        .badge-done { background: #d1fae5; color: #065f46; }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: white;
            border-bottom: 2px solid var(--border);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .toolbar-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 8px;
        }

        .current-project {
            font-weight: 600;
            font-size: 18px;
            color: var(--primary);
        }

        #map {
            flex: 1;
            position: relative;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.3);
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 2px solid var(--border);
            background: linear-gradient(135deg, var(--bg) 0%, white 100%);
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--bg);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Barlow', sans-serif;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .photo-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }

        .photo-upload:hover {
            border-color: var(--accent);
            background: white;
        }

        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 12px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        /* Points List */
        .points-panel {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 320px;
            max-height: calc(100vh - 160px);
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            overflow: hidden;
            z-index: 1000;
            display: none;
        }

        .points-panel.active {
            display: flex;
            flex-direction: column;
        }

        .points-header {
            padding: 16px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .points-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .close-panel {
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
        }

        .points-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .point-item {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .point-item:hover {
            border-color: var(--accent);
            transform: translateX(-4px);
        }

        .point-item.selected {
            border-color: var(--accent);
            background: #fff7ed;
        }

        .point-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .point-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
        }

        .point-address {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-style: italic;
        }

        .point-comment {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .point-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .status-selector {
            display: flex;
            gap: 6px;
            background: var(--bg);
            padding: 4px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .btn-status {
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-status:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-status.status-todo.active {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .btn-status.status-progress.active {
            border-color: #3b82f6;
            background: #dbeafe;
        }

        .btn-status.status-done.active {
            border-color: #10b981;
            background: #d1fae5;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        /* Custom Leaflet popup */
        .custom-popup {
            font-family: 'Barlow', sans-serif;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
        }

        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 240px !important;
        }

        /* Leaflet layer control styling */
        .leaflet-control-layers {
            border-radius: 8px !important;
            border: 2px solid var(--border) !important;
            box-shadow: 0 4px 12px var(--shadow) !important;
        }

        .leaflet-control-layers-toggle {
            background-size: 20px 20px !important;
            width: 40px !important;
            height: 40px !important;
        }

        .leaflet-control-layers-list {
            font-family: 'Barlow', sans-serif !important;
        }

        .leaflet-control-layers label {
            font-size: 14px !important;
            padding: 4px 0 !important;
        }

        .popup-content {
            padding: 12px;
        }

        .popup-status {
            margin-bottom: 8px;
        }

        .popup-comment {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-width: 100%;
                position: fixed;
                left: -100%;
                transition: left 0.3s;
                z-index: 1500;
                height: 100vh;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .main-content {
                width: 100%;
            }

            .toolbar {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .toolbar-left,
            .toolbar-right {
                width: 100%;
                justify-content: center;
            }

            .toolbar-right {
                flex-wrap: wrap;
            }

            .btn-sm {
                padding: 10px 16px;
                font-size: 13px;
            }

            .points-panel {
                width: calc(100% - 32px);
                right: 16px;
                left: 16px;
                max-height: 60vh;
            }

            .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            .form-input,
            .form-textarea,
            .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Larger touch targets for mobile */
            .btn {
                min-height: 44px;
            }

            .project-card {
                padding: 20px;
            }

            .photo-upload {
                padding: 40px 20px;
                font-size: 16px;
            }

            /* Menu toggle button */
            .menu-toggle {
                position: fixed;
                top: 16px;
                left: 16px;
                z-index: 1600;
                background: var(--primary);
                color: white;
                border: none;
                width: 48px;
                height: 48px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                box-shadow: 0 4px 12px var(--shadow);
                cursor: pointer;
            }
        }

        @media (min-width: 769px) {
            .menu-toggle {
                display: none;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <!-- Mobile menu toggle -->
    <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>

    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="header">
                <h1>üèóÔ∏è VRDControl <span class="version">Alpha 0.5.1</span></h1>
                <p>Suivi professionnel de chantiers</p>
            </div>

            <div class="project-section">
                <div class="section-title">Nouveau Projet</div>
                <button class="btn btn-primary" onclick="showNewProjectModal()">
                    ‚ûï Cr√©er un projet
                </button>
            </div>

            <div class="project-section">
                <div class="section-title">Archives</div>
                <button class="btn btn-secondary" onclick="showArchivesModal()">
                    üì¶ Voir les archives (<span id="archiveCount">0</span>)
                </button>
            </div>

            <div class="project-list" id="projectList">
                <!-- Projects will be added here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="toolbar">
                <div class="toolbar-left">
                    <div class="current-project" id="currentProjectName">
                        S√©lectionnez un projet
                    </div>
                </div>
                <div class="toolbar-right" id="projectTools" style="display: none;">
                    <button class="btn btn-secondary btn-sm" onclick="centerOnMyLocation()" title="Me localiser">
                        üìç Ma position
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="showPointsPanel()">
                        üìç Points (<span id="pointsCount">0</span>)
                    </button>
                    <button class="btn btn-success btn-sm" onclick="generateReport()">
                        üìä G√©n√©rer Rapport
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="archiveProject()">
                        üì¶ Archiver
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteCurrentProject()" title="Supprimer ce projet">
                        üóëÔ∏è Supprimer
                    </button>
                </div>
            </div>

            <div id="map"></div>

            <!-- Report Generation Progress Overlay -->
            <div id="reportProgress" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 10000; text-align: center; min-width: 320px;">
                <h3 style="margin: 0 0 20px 0; color: #0f172a;">‚è≥ G√©n√©ration du rapport</h3>
                <div style="font-size: 24px; font-weight: bold; color: #f97316; margin-bottom: 10px;" id="reportProgressText">Point 1/5</div>
                <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 20px;">
                    <div id="reportProgressBar" style="background: linear-gradient(90deg, #f97316, #ea580c); height: 100%; width: 20%; transition: width 0.3s;"></div>
                </div>
                <div style="color: #64748b; font-size: 14px; margin-bottom: 20px;" id="reportProgressDetail">Capture de la carte...</div>
                <button onclick="cancelReportGeneration()" style="background: #ef4444; color: white; border: none; padding: 10px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    ‚ùå Annuler la g√©n√©ration
                </button>
            </div>
            
            <!-- Backdrop for progress -->
            <div id="reportProgressBackdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999;"></div>

            <!-- Points Panel -->
            <div class="points-panel" id="pointsPanel">
                <div class="points-header">
                    <h3>Points du projet</h3>
                    <button class="close-panel" onclick="hidePointsPanel()">‚úï</button>
                </div>
                <div class="points-list" id="pointsList">
                    <!-- Points will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="newProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau Projet</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Nom du projet *</label>
                    <input type="text" class="form-input" id="projectName" placeholder="Ex: Suivi travaux Route D1">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="projectDescription" placeholder="Description du projet..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newProjectModal')">Annuler</button>
                <button class="btn btn-primary" onclick="createProject()">Cr√©er le projet</button>
            </div>
        </div>
    </div>

    <!-- New Point Modal -->
    <div class="modal" id="newPointModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Nouveau Point</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titre *</label>
                    <input type="text" class="form-input" id="pointTitle" placeholder="Ex: R√©paration chauss√©e">
                </div>
                <div class="form-group">
                    <label class="form-label">Commentaire / T√¢che √† effectuer *</label>
                    <textarea class="form-textarea" id="pointComment" placeholder="D√©crivez les travaux √† r√©aliser..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo</label>
                    <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                        <div>üì∑ Cliquez pour prendre une photo</div>
                        <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none" onchange="previewPhoto(event)">
                        <img id="photoPreview" class="photo-preview" style="display: none">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="pointStatus">
                        <option value="todo">√Ä faire</option>
                        <option value="progress">En cours</option>
                        <option value="done">Termin√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse (d√©tect√©e)</label>
                    <input type="text" class="form-input" id="pointAddress" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('newPointModal')">Annuler</button>
                <button class="btn btn-primary" onclick="savePoint()">Enregistrer le point</button>
            </div>
        </div>
    </div>

    <!-- Edit Point Modal -->
    <div class="modal" id="editPointModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Modifier le Point</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Titre</label>
                    <input type="text" class="form-input" id="editPointTitle">
                </div>
                <div class="form-group">
                    <label class="form-label">Commentaire</label>
                    <textarea class="form-textarea" id="editPointComment"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Statut</label>
                    <select class="form-select" id="editPointStatus">
                        <option value="todo">√Ä faire</option>
                        <option value="progress">En cours</option>
                        <option value="done">Termin√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Photo actuelle</label>
                    <img id="editPhotoPreview" class="photo-preview" style="display: none; max-width: 100%;">
                    <div style="margin-top: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="document.getElementById('editPhotoInput').click()">
                            üì∑ Prendre une photo
                        </button>
                        <input type="file" id="editPhotoInput" accept="image/*" capture="environment" style="display: none" onchange="previewEditPhoto(event)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deletePoint()">Supprimer</button>
                <button class="btn btn-secondary" onclick="closeModal('editPointModal')">Annuler</button>
                <button class="btn btn-primary" onclick="updatePoint()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Archive Modal -->
    <div class="modal" id="archiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Archiver le projet</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-muted);">
                    Vous √™tes sur le point d'archiver le projet <strong id="archiveProjectName"></strong>.
                    Les archives sont conserv√©es pendant la dur√©e choisie, puis supprim√©es automatiquement.
                </p>
                <div class="form-group">
                    <label class="form-label">Dur√©e de conservation</label>
                    <select class="form-select" id="archiveDuration">
                        <option value="3">3 mois</option>
                        <option value="6" selected>6 mois</option>
                        <option value="9">9 mois</option>
                        <option value="12">12 mois</option>
                    </select>
                </div>
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; font-size: 14px; color: #92400e;">
                    ‚ö†Ô∏è Le projet sera retir√© des projets actifs et accessible uniquement via les archives.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('archiveModal')">Annuler</button>
                <button class="btn btn-primary" onclick="confirmArchive()">Archiver</button>
            </div>
        </div>
    </div>

    <!-- Archives List Modal -->
    <div class="modal" id="archivesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Archives</h2>
            </div>
            <div class="modal-body">
                <div id="archivesList">
                    <!-- Archives will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('archivesModal')">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let map = null;
        let currentProject = null;
        let projects = [];
        let currentMarker = null;
        let currentLatLng = null;
        let markers = [];
        let editingPointId = null;

        // Initialize app
        async function initApp() {
            await loadProjects();
            await loadArchives();
            initMap();
            renderProjects();
            cleanExpiredArchives();
        }

        // Initialize map
        function initMap() {
            map = L.map('map', {
                maxZoom: 19  // Valeur stable qui fonctionne bien
            }).setView([48.8566, 2.3522], 13); // Paris par d√©faut

            // Diff√©rentes couches de carte
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });

            // Vue satellite Esri - Fiable et mondial
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            });

            // Ajouter la couche par d√©faut
            osmLayer.addTo(map);

            // Contr√¥le des couches
            const baseLayers = {
                "üó∫Ô∏è Carte standard": osmLayer,
                "üõ∞Ô∏è Satellite": satelliteLayer
            };

            L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

            // Stocker les couches pour acc√®s global
            window.mapLayers = {
                standard: osmLayer,
                satellite: satelliteLayer
            };

            // Add click handler
            map.on('click', function(e) {
                if (currentProject) {
                    currentLatLng = e.latlng;
                    
                    // Remove temporary marker if exists
                    if (currentMarker) {
                        map.removeLayer(currentMarker);
                    }
                    
                    // Add temporary marker
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: #f59e0b; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 1s infinite;"></div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    currentMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon }).addTo(map);
                    
                    getAddressFromLatLng(e.latlng.lat, e.latlng.lng);
                    showNewPointModal();
                } else {
                    alert('Veuillez d\'abord s√©lectionner un projet');
                }
            });
        }

        // Storage functions
        async function loadProjects() {
            // Check if storage is available
            if (!window.storage) {
                // Fallback to localStorage
                const stored = localStorage.getItem('vrd_projects');
                projects = stored ? JSON.parse(stored) : [];
                return;
            }

            try {
                const result = await window.storage.list('project:');
                if (result && result.keys) {
                    projects = [];
                    for (const key of result.keys) {
                        const data = await window.storage.get(key);
                        if (data) {
                            projects.push(JSON.parse(data.value));
                        }
                    }
                }
            } catch (error) {
                console.log('Chargement depuis localStorage');
                const stored = localStorage.getItem('vrd_projects');
                projects = stored ? JSON.parse(stored) : [];
            }
        }

        async function saveProject(project) {
            console.log('=== D√âBUT saveProject ===');
            console.log('Projet √† sauvegarder:', project);
            
            // Update in projects array
            const index = projects.findIndex(p => p.id === project.id);
            console.log('Index du projet dans le tableau:', index);
            
            if (index >= 0) {
                projects[index] = project;
                console.log('Projet mis √† jour dans le tableau');
            } else {
                projects.push(project);
                console.log('Projet ajout√© au tableau');
            }

            if (!window.storage) {
                console.log('window.storage non disponible, utilisation de localStorage');
                try {
                    localStorage.setItem('vrd_projects', JSON.stringify(projects));
                    console.log('‚úÖ Sauvegarde localStorage r√©ussie');
                    return;
                } catch (e) {
                    console.error('‚ùå Erreur localStorage:', e);
                    throw e;
                }
            }

            try {
                console.log('Tentative de sauvegarde avec window.storage...');
                const result = await window.storage.set(`project:${project.id}`, JSON.stringify(project));
                console.log('‚úÖ R√©sultat window.storage:', result);
            } catch (error) {
                console.log('‚ùå √âchec window.storage, basculement vers localStorage');
                console.error('Erreur:', error);
                try {
                    localStorage.setItem('vrd_projects', JSON.stringify(projects));
                    console.log('‚úÖ Sauvegarde localStorage de secours r√©ussie');
                } catch (e) {
                    console.error('‚ùå Erreur localStorage de secours:', e);
                    throw e;
                }
            }
            console.log('=== FIN saveProject ===');
        }

        async function deleteProjectFromStorage(projectId) {
            if (!window.storage) {
                projects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('vrd_projects', JSON.stringify(projects));
                return;
            }

            try {
                await window.storage.delete(`project:${projectId}`);
            } catch (error) {
                console.log('Suppression depuis localStorage');
                projects = projects.filter(p => p.id !== projectId);
                localStorage.setItem('vrd_projects', JSON.stringify(projects));
            }
        }

        // Project functions
        function showNewProjectModal() {
            document.getElementById('newProjectModal').classList.add('active');
        }

        async function createProject() {
            console.log('=== D√âBUT CR√âATION PROJET ===');
            
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();

            console.log('Nom du projet:', name);
            console.log('Description:', description);

            if (!name) {
                alert('Veuillez saisir un nom de projet');
                return;
            }

            const project = {
                id: Date.now().toString(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                points: []
            };

            console.log('Projet cr√©√©:', project);

            projects.push(project);
            console.log('Nombre total de projets:', projects.length);
            
            try {
                await saveProject(project);
                console.log('‚úÖ Projet sauvegard√© avec succ√®s');
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde du projet:', error);
                alert('Erreur lors de la cr√©ation du projet: ' + error.message);
                projects.pop(); // Retirer le projet si √©chec
                return;
            }
            
            closeModal('newProjectModal');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            
            renderProjects();
            selectProject(project.id);
            
            console.log('=== FIN CR√âATION PROJET ===');
        }

        function renderProjects() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';

            if (projects.length === 0) {
                projectList.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-muted);">Aucun projet. Cr√©ez-en un !</p>';
                return;
            }

            projects.forEach(project => {
                const stats = getProjectStats(project);
                const card = document.createElement('div');
                card.className = `project-card ${currentProject?.id === project.id ? 'active' : ''}`;
                card.onclick = () => selectProject(project.id);
                
                card.innerHTML = `
                    <div class="project-name">${project.name}</div>
                    <div class="project-meta">
                        <span>üìç ${project.points.length} pts</span>
                        <span>‚úÖ ${stats.done}/${project.points.length}</span>
                    </div>
                    <button class="btn-icon btn-delete-project" onclick="event.stopPropagation(); deleteProjectConfirm('${project.id}')" title="Supprimer projet">
                        üóëÔ∏è
                    </button>
                `;
                
                projectList.appendChild(card);
            });
        }

        function getProjectStats(project) {
            const stats = {
                todo: 0,
                progress: 0,
                done: 0
            };

            project.points.forEach(point => {
                stats[point.status]++;
            });

            return stats;
        }

        function selectProject(projectId) {
            currentProject = projects.find(p => p.id === projectId);
            if (!currentProject) return;

            document.getElementById('currentProjectName').textContent = currentProject.name;
            document.getElementById('projectTools').style.display = 'flex';
            
            renderProjects();
            renderMapMarkers();
            updatePointsCount();

            // Close mobile menu
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('mobile-open');
            }

            // Center map on first point or default location
            if (currentProject.points.length > 0) {
                const firstPoint = currentProject.points[0];
                map.setView([firstPoint.lat, firstPoint.lng], 15);
            }
        }

        // Map markers
        function renderMapMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!currentProject) return;

            currentProject.points.forEach(point => {
                const color = point.status === 'done' ? '#10b981' : 
                             point.status === 'progress' ? '#3b82f6' : '#f59e0b';
                
                // Afficher le num√©ro du point sur le marqueur
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            background: ${color}; 
                            color: white;
                            width: 36px; 
                            height: 36px; 
                            border-radius: 50%; 
                            border: 3px solid white; 
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 16px;
                        ">${point.number || '?'}</div>
                    `,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });

                const marker = L.marker([point.lat, point.lng], { icon })
                    .addTo(map)
                    .bindPopup(createPopupContent(point), {
                        className: 'custom-popup',
                        maxWidth: 240
                    });

                marker.pointId = point.id;
                marker.on('click', () => selectPointOnMap(point.id));
                markers.push(marker);
            });
        }

        function createPopupContent(point) {
            const statusBadge = point.status === 'done' ? 'badge-done' :
                              point.status === 'progress' ? 'badge-progress' : 'badge-todo';
            const statusText = point.status === 'done' ? 'Termin√©' :
                             point.status === 'progress' ? 'En cours' : '√Ä faire';

            return `
                <div class="popup-content">
                    <div class="popup-status">
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </div>
                    <strong>${point.title}</strong>
                    <div class="popup-comment">${point.comment}</div>
                    ${point.photo ? `<img src="${point.photo}" class="popup-image">` : ''}
                    <button class="btn btn-secondary btn-sm" onclick="editPointModal('${point.id}')" style="width: 100%;">
                        ‚úèÔ∏è Modifier
                    </button>
                </div>
            `;
        }

        function selectPointOnMap(pointId) {
            document.querySelectorAll('.point-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const pointElement = document.querySelector(`[data-point-id="${pointId}"]`);
            if (pointElement) {
                pointElement.classList.add('selected');
                pointElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Points panel
        function showPointsPanel() {
            document.getElementById('pointsPanel').classList.add('active');
            renderPointsList();
        }

        function hidePointsPanel() {
            document.getElementById('pointsPanel').classList.remove('active');
        }

        function renderPointsList() {
            const pointsList = document.getElementById('pointsList');
            pointsList.innerHTML = '';

            if (!currentProject || currentProject.points.length === 0) {
                pointsList.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--text-muted);">Aucun point sur ce projet</p>';
                return;
            }

            currentProject.points.forEach(point => {
                const statusBadge = point.status === 'done' ? 'badge-done' :
                                  point.status === 'progress' ? 'badge-progress' : 'badge-todo';
                const statusText = point.status === 'done' ? 'Termin√©' :
                                 point.status === 'progress' ? 'En cours' : '√Ä faire';

                const item = document.createElement('div');
                item.className = 'point-item';
                item.setAttribute('data-point-id', point.id);
                item.onclick = () => {
                    map.setView([point.lat, point.lng], 18);
                    markers.find(m => m.pointId === point.id)?.openPopup();
                };

                item.innerHTML = `
                    <div class="point-header">
                        <div class="point-title">${point.title}</div>
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </div>
                    <div class="point-address">${point.address}</div>
                    <div class="point-comment">${point.comment.substring(0, 100)}${point.comment.length > 100 ? '...' : ''}</div>
                    <div class="point-actions">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); editPointModal('${point.id}')">
                            ‚úèÔ∏è Modifier
                        </button>
                        <div class="status-selector">
                            <button 
                                class="btn-status ${point.status === 'todo' ? 'active status-todo' : 'status-todo'}" 
                                onclick="event.stopPropagation(); setPointStatus('${point.id}', 'todo')"
                                title="√Ä faire">
                                ‚è∏Ô∏è
                            </button>
                            <button 
                                class="btn-status ${point.status === 'progress' ? 'active status-progress' : 'status-progress'}" 
                                onclick="event.stopPropagation(); setPointStatus('${point.id}', 'progress')"
                                title="En cours">
                                ‚è≥
                            </button>
                            <button 
                                class="btn-status ${point.status === 'done' ? 'active status-done' : 'status-done'}" 
                                onclick="event.stopPropagation(); setPointStatus('${point.id}', 'done')"
                                title="Termin√©">
                                ‚úÖ
                            </button>
                        </div>
                    </div>
                `;

                pointsList.appendChild(item);
            });
        }

        function updatePointsCount() {
            if (currentProject) {
                document.getElementById('pointsCount').textContent = currentProject.points.length;
            }
        }

        // Fonction pour mettre √† jour les statistiques du projet en temps r√©el
        function updateProjectStats() {
            if (!currentProject) return;
            
            // Forcer le rafra√Æchissement de la liste des projets dans la sidebar
            renderProjects();
            
            // Mettre √† jour le compteur dans la toolbar
            const pointsCount = document.getElementById('pointsCount');
            if (pointsCount) {
                pointsCount.textContent = currentProject.points.length;
            }
        }

        // Point CRUD
        function showNewPointModal() {
            document.getElementById('newPointModal').classList.add('active');
        }

        async function getAddressFromLatLng(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                document.getElementById('pointAddress').value = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                document.getElementById('pointAddress').value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, function(compressedDataUrl) {
                    const preview = document.getElementById('photoPreview');
                    preview.src = compressedDataUrl;
                    preview.style.display = 'block';
                });
            }
        }

        function previewEditPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                compressImage(file, function(compressedDataUrl) {
                    const preview = document.getElementById('editPhotoPreview');
                    preview.src = compressedDataUrl;
                    preview.style.display = 'block';
                });
            }
        }

        // Fonction de compression d'image
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    
                    // Taille maximale : 1200px de largeur
                    let width = img.width;
                    let height = img.height;
                    const maxWidth = 1200;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Compression JPEG √† 70% de qualit√©
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    console.log('Image originale:', (e.target.result.length / 1024).toFixed(2), 'KB');
                    console.log('Image compress√©e:', (compressedDataUrl.length / 1024).toFixed(2), 'KB');
                    
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        async function savePoint() {
            console.log('=== D√âBUT SAUVEGARDE POINT ===');
            
            const title = document.getElementById('pointTitle').value.trim();
            const comment = document.getElementById('pointComment').value.trim();
            const status = document.getElementById('pointStatus').value;
            const address = document.getElementById('pointAddress').value;
            const photoPreview = document.getElementById('photoPreview');

            console.log('Donn√©es du formulaire:', { title, comment, status, address });
            console.log('currentLatLng:', currentLatLng);
            console.log('currentProject:', currentProject);

            if (!title || !comment) {
                alert('Veuillez remplir tous les champs obligatoires');
                return;
            }

            if (!currentLatLng) {
                alert('Erreur: Position non d√©finie. Veuillez cliquer sur la carte.');
                return;
            }

            if (!currentProject) {
                alert('Erreur: Aucun projet s√©lectionn√©');
                return;
            }

            const point = {
                id: Date.now().toString(),
                number: currentProject.points.length > 0 
                    ? Math.max(...currentProject.points.map(p => p.number || 0)) + 1 
                    : 1, // Num√©ro bas√© sur le max existant, pas sur la longueur du tableau
                title: title,
                comment: comment,
                status: status,
                statusHistory: [
                    {
                        status: status,
                        date: new Date().toISOString(),
                        user: 'Admin' // Pour l'instant, sera remplac√© par auth plus tard
                    }
                ], // Historique des changements de statut
                address: address || `${currentLatLng.lat.toFixed(6)}, ${currentLatLng.lng.toFixed(6)}`,
                lat: currentLatLng.lat,
                lng: currentLatLng.lng,
                photo: photoPreview.style.display !== 'none' ? photoPreview.src : null,
                createdAt: new Date().toISOString()
            };

            console.log('Point cr√©√©:', point);
            console.log('Taille de la photo:', point.photo ? (point.photo.length / 1024).toFixed(2) + ' KB' : 'Pas de photo');

            // Ajouter le point au projet
            if (!currentProject.points) {
                currentProject.points = [];
            }
            currentProject.points.push(point);
            console.log('Point ajout√© au projet. Nombre de points:', currentProject.points.length);
            
            try {
                console.log('Tentative de sauvegarde du projet...');
                await saveProject(currentProject);
                console.log('‚úÖ Point sauvegard√© avec succ√®s');
                
                // Fermer la modale et nettoyer
                closeModal('newPointModal');
                resetPointForm();
                
                // Remove temporary marker
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
                
                renderMapMarkers();
                renderPointsList();
                updatePointsCount();
                updateProjectStats(); // Mettre √† jour les stats en temps r√©el
                
                // Reset currentLatLng
                currentLatLng = null;
                
                // Ne pas afficher d'alert si tout va bien
                
            } catch (error) {
                console.error('‚ùå Erreur lors de la sauvegarde:', error);
                console.error('Stack trace:', error.stack);
                
                // Retirer le point du projet si la sauvegarde a √©chou√©
                currentProject.points.pop();
                
                if (error.message.includes('quota')) {
                    alert('‚ö†Ô∏è Espace de stockage satur√©!\n\nLes photos sont trop volumineuses. Solutions:\n‚Ä¢ Archivez les anciens projets\n‚Ä¢ Utilisez moins de photos\n‚Ä¢ Les photos sont maintenant compress√©es automatiquement');
                } else {
                    alert('‚ùå Erreur lors de la sauvegarde du point: ' + error.message);
                }
            }
        }

        function editPointModal(pointId) {
            editingPointId = pointId;
            const point = currentProject.points.find(p => p.id === pointId);
            if (!point) return;

            document.getElementById('editPointTitle').value = point.title;
            document.getElementById('editPointComment').value = point.comment;
            document.getElementById('editPointStatus').value = point.status;
            
            const preview = document.getElementById('editPhotoPreview');
            if (point.photo) {
                preview.src = point.photo;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            document.getElementById('editPointModal').classList.add('active');
        }

        async function updatePoint() {
            const point = currentProject.points.find(p => p.id === editingPointId);
            if (!point) return;

            const newStatus = document.getElementById('editPointStatus').value;
            const oldStatus = point.status;

            point.title = document.getElementById('editPointTitle').value.trim();
            point.comment = document.getElementById('editPointComment').value.trim();
            point.status = newStatus;
            
            // Ajouter √† l'historique si le statut a chang√©
            if (oldStatus !== newStatus) {
                if (!point.statusHistory) {
                    point.statusHistory = [{
                        status: oldStatus,
                        date: point.createdAt,
                        user: 'Admin'
                    }];
                }
                point.statusHistory.push({
                    status: newStatus,
                    date: new Date().toISOString(),
                    user: 'Admin', // Sera remplac√© par auth utilisateur plus tard
                    previousStatus: oldStatus
                });
            }
            
            const preview = document.getElementById('editPhotoPreview');
            if (preview.style.display !== 'none') {
                point.photo = preview.src;
            }

            await saveProject(currentProject);
            closeModal('editPointModal');
            renderMapMarkers();
            renderPointsList();
            updateProjectStats();
        }

        async function deletePoint() {
            if (!confirm('Voulez-vous vraiment supprimer ce point ?')) return;

            currentProject.points = currentProject.points.filter(p => p.id !== editingPointId);
            await saveProject(currentProject);

            closeModal('editPointModal');
            renderMapMarkers();
            renderPointsList();
            updatePointsCount();
            updateProjectStats(); // Mettre √† jour les stats apr√®s suppression
        }

        async function setPointStatus(pointId, newStatus) {
            const point = currentProject.points.find(p => p.id === pointId);
            if (!point) return;

            // Ne rien faire si le statut est d√©j√† le m√™me
            if (point.status === newStatus) {
                return;
            }

            const oldStatus = point.status;
            point.status = newStatus;
            
            // Ajouter √† l'historique
            if (!point.statusHistory) {
                point.statusHistory = [];
            }
            point.statusHistory.push({
                status: newStatus,
                date: new Date().toISOString(),
                user: 'Admin', // Sera remplac√© par auth utilisateur plus tard
                previousStatus: oldStatus
            });

            await saveProject(currentProject);
            renderMapMarkers();
            renderPointsList();
            updateProjectStats();
        }

        function resetPointForm() {
            document.getElementById('pointTitle').value = '';
            document.getElementById('pointComment').value = '';
            document.getElementById('pointStatus').value = 'todo';
            document.getElementById('pointAddress').value = '';
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('photoInput').value = '';
        }

        // Report generation with cancellation support
        let reportGenerationCancelled = false;

        function showReportProgress(current, total, detail) {
            document.getElementById('reportProgress').style.display = 'block';
            document.getElementById('reportProgressBackdrop').style.display = 'block';
            document.getElementById('reportProgressText').textContent = `Point ${current}/${total}`;
            document.getElementById('reportProgressDetail').textContent = detail;
            const percentage = (current / total) * 100;
            document.getElementById('reportProgressBar').style.width = percentage + '%';
        }

        function hideReportProgress() {
            document.getElementById('reportProgress').style.display = 'none';
            document.getElementById('reportProgressBackdrop').style.display = 'none';
        }

        function cancelReportGeneration() {
            if (confirm('‚ö†Ô∏è Voulez-vous vraiment annuler la g√©n√©ration du rapport ?')) {
                reportGenerationCancelled = true;
                hideReportProgress();
            }
        }

        // Report generation
        async function generateReport() {
            if (!currentProject || currentProject.points.length === 0) {
                alert('Aucun point √† exporter pour ce projet');
                return;
            }

            // Show format selection dialog
            const format = prompt(
                'üéØ Choisissez le format de rapport :\n\n' +
                '1 - Rapport HTML avec photos et cartes (recommand√©)\n' +
                '2 - Fichier CSV/Excel (donn√©es uniquement)\n' +
                '3 - Fichier texte simple\n\n' +
                'Entrez 1, 2 ou 3 :'
            );

            if (format === '1') {
                // Ask for map layer preference
                const mapLayer = prompt(
                    'üó∫Ô∏è Quel fond de carte pour les miniatures ?\n\n' +
                    '1 - Carte standard (OpenStreetMap)\n' +
                    '2 - Vue satellite\n\n' +
                    'Entrez 1 ou 2 :'
                );
                
                let layerChoice = 'standard';
                if (mapLayer === '2') layerChoice = 'satellite';
                
                // Utiliser le zoom recommand√© pour les rapports (19 = stable)
                const zoom = 19;
                
                await generateHTMLReportWithMaps(layerChoice, zoom);
            } else if (format === '2') {
                await generateExcelReport();
            } else if (format === '3') {
                generateTextReport();
            } else if (format !== null) {
                alert('Format invalide. Veuillez choisir 1, 2 ou 3');
            }
        }

        async function captureMapForPoint(point, layerType = 'standard', zoomLevel = 19) {
            return new Promise((resolve) => {
                // Sauvegarder l'√©tat actuel
                const originalCenter = map.getCenter();
                const originalZoom = map.getZoom();
                
                // Obtenir toutes les couches actives actuellement
                const currentLayers = [];
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) {
                        currentLayers.push(layer);
                    }
                });
                
                // Retirer toutes les couches de tuiles
                currentLayers.forEach(layer => map.removeLayer(layer));
                
                // Ajouter la couche choisie
                const chosenLayer = window.mapLayers[layerType];
                if (chosenLayer) {
                    chosenLayer.addTo(map);
                }
                
                // IMPORTANT : Centrer et zoomer en une seule op√©ration
                map.setView([point.lat, point.lng], zoomLevel, {
                    animate: false // Pas d'animation pour √©viter les probl√®mes de timing
                });
                
                // Forcer le recalcul de la taille de la carte
                map.invalidateSize();
                
                // Attendre que le centrage soit effectif
                setTimeout(() => {
                    // Cr√©er un marqueur temporaire VISIBLE pour la capture
                    const captureIcon = L.divIcon({
                        className: 'capture-marker',
                        html: `
                            <div style="position: relative;">
                                <div style="
                                    background: #f97316; 
                                    width: 50px; 
                                    height: 50px; 
                                    border-radius: 50%; 
                                    border: 5px solid white; 
                                    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 28px;
                                ">üìç</div>
                                <div style="
                                    position: absolute;
                                    bottom: -30px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background: #f97316;
                                    color: white;
                                    padding: 6px 12px;
                                    border-radius: 6px;
                                    white-space: nowrap;
                                    font-weight: bold;
                                    font-size: 14px;
                                    box-shadow: 0 3px 10px rgba(0,0,0,0.4);
                                    border: 2px solid white;
                                ">üéØ TRAVAUX ICI</div>
                            </div>
                        `,
                        iconSize: [50, 50],
                        iconAnchor: [25, 25]
                    });
                    
                    const captureMarker = L.marker([point.lat, point.lng], { icon: captureIcon }).addTo(map);
                    
                    // Attendre que le marqueur soit rendu ET que les tuiles se chargent
                    setTimeout(async () => {
                        try {
                            const mapElement = document.getElementById('map');
                            
                            // Capturer avec html2canvas
                            const canvas = await html2canvas(mapElement, {
                                useCORS: true,
                                allowTaint: true,
                                backgroundColor: '#f0f0f0',
                                scale: 2,
                                logging: false
                            });
                            
                            // Convertir en JPEG
                            const imageData = canvas.toDataURL('image/jpeg', 0.90);
                            
                            console.log('‚úÖ Carte captur√©e:', point.title, '-', (imageData.length / 1024).toFixed(2), 'KB');
                            
                            // Nettoyer : retirer le marqueur de capture
                            map.removeLayer(captureMarker);
                            
                            // Retirer la couche utilis√©e pour la capture
                            if (chosenLayer) {
                                map.removeLayer(chosenLayer);
                            }
                            
                            // Remettre les couches originales
                            currentLayers.forEach(layer => layer.addTo(map));
                            
                            // Restaurer la vue originale
                            map.setView(originalCenter, originalZoom, { animate: false });
                            
                            resolve(imageData);
                        } catch (error) {
                            console.error('‚ùå Erreur capture carte:', point.title, error);
                            
                            // Nettoyage en cas d'erreur
                            try {
                                map.removeLayer(captureMarker);
                            } catch (e) {}
                            
                            if (chosenLayer) {
                                try {
                                    map.removeLayer(chosenLayer);
                                } catch (e) {}
                            }
                            
                            currentLayers.forEach(layer => {
                                try {
                                    layer.addTo(map);
                                } catch (e) {}
                            });
                            
                            map.setView(originalCenter, originalZoom, { animate: false });
                            
                            resolve(null);
                        }
                    }, 3000); // 3 secondes pour garantir le chargement des tuiles
                }, 300); // Attendre que le setView soit effectif
            });
        }

        // Fonction pour trier les points par proximit√© (algorithme du plus proche voisin)
        function sortPointsByProximity(points) {
            if (points.length <= 1) return points;
            
            const sorted = [];
            const remaining = [...points];
            
            // Commencer par le premier point
            sorted.push(remaining.shift());
            
            // Trouver le point le plus proche √† chaque it√©ration
            while (remaining.length > 0) {
                const lastPoint = sorted[sorted.length - 1];
                let closestIndex = 0;
                let minDistance = Infinity;
                
                for (let i = 0; i < remaining.length; i++) {
                    const distance = Math.sqrt(
                        Math.pow(remaining[i].lat - lastPoint.lat, 2) +
                        Math.pow(remaining[i].lng - lastPoint.lng, 2)
                    );
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestIndex = i;
                    }
                }
                
                sorted.push(remaining.splice(closestIndex, 1)[0]);
            }
            
            // Mettre √† jour les num√©ros selon l'ordre de tri
            sorted.forEach((point, index) => {
                point.sortedNumber = index + 1;
            });
            
            return sorted;
        }

        // Fonction pour capturer la carte g√©n√©rale avec tous les points num√©rot√©s
        async function captureOverviewMap(points, layerType = 'standard') {
            return new Promise((resolve) => {
                // Sauvegarder l'√©tat actuel
                const originalCenter = map.getCenter();
                const originalZoom = map.getZoom();
                
                // Obtenir toutes les couches actives
                const currentLayers = [];
                map.eachLayer(layer => {
                    if (layer instanceof L.TileLayer) {
                        currentLayers.push(layer);
                    }
                });
                
                // Retirer toutes les couches de tuiles
                currentLayers.forEach(layer => map.removeLayer(layer));
                
                // Ajouter la couche choisie
                const chosenLayer = window.mapLayers[layerType];
                if (chosenLayer) {
                    chosenLayer.addTo(map);
                }
                
                // Calculer les limites pour inclure tous les points
                const bounds = L.latLngBounds(points.map(p => [p.lat, p.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
                
                // Forcer le refresh de la carte
                map.invalidateSize();
                
                // Les marqueurs num√©rot√©s sont D√âJ√Ä sur la carte (via renderMapMarkers)
                // On a juste besoin d'attendre que les tuiles se chargent
                
                setTimeout(async () => {
                    console.log(`üîç Capture de la carte avec les ${points.length} marqueurs existants`);
                    
                    try {
                        const mapElement = document.getElementById('map');
                        
                        const canvas = await html2canvas(mapElement, {
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#f0f0f0',
                            scale: 2,
                            logging: false
                        });
                        
                        const imageData = canvas.toDataURL('image/jpeg', 0.90);
                        
                        console.log('‚úÖ Carte g√©n√©rale captur√©e:', (imageData.length / 1024).toFixed(2), 'KB');
                        
                        // Retirer la couche
                        if (chosenLayer) {
                            map.removeLayer(chosenLayer);
                        }
                        
                        // Remettre les couches originales
                        currentLayers.forEach(layer => layer.addTo(map));
                        
                        // Restaurer la vue
                        map.setView(originalCenter, originalZoom);
                        
                        resolve(imageData);
                    } catch (error) {
                        console.error('‚ùå Erreur capture carte g√©n√©rale:', error);
                        
                        if (chosenLayer) {
                            try { map.removeLayer(chosenLayer); } catch (e) {}
                        }
                        
                        currentLayers.forEach(layer => {
                            try { layer.addTo(map); } catch (e) {}
                        });
                        
                        map.setView(originalCenter, originalZoom);
                        
                        resolve(null);
                    }
                }, 3000); // 3 secondes pour charger les tuiles
            });
        }

        // Variable globale pour annuler g√©n√©ration rapport
        let reportGenerationAborted = false;

        async function generateHTMLReportWithMaps(layerType = 'standard', zoomLevel = 19) {
            // Reset cancellation flag
            reportGenerationCancelled = false;
            
            // Show loading indicator with cancel button
            const button = document.querySelector('#projectTools button[onclick="generateReport()"]');
            const originalText = button.textContent;
            button.textContent = '‚è≥ G√©n√©ration...';
            button.disabled = true;
            
            // Add cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-danger';
            cancelBtn.innerHTML = '‚ùå Annuler';
            cancelBtn.style.marginLeft = '8px';
            cancelBtn.onclick = () => {
                if (confirm('‚ùå Annuler la g√©n√©ration du rapport ?')) {
                    reportGenerationCancelled = true;
                    cancelBtn.textContent = '‚èπÔ∏è Annulation...';
                    cancelBtn.disabled = true;
                }
            };
            button.parentElement.appendChild(cancelBtn);
            
            try {
                // NE PAS trier - garder l'ordre de cr√©ation (num√©rotation correcte)
                const points = [...currentProject.points];
                
                console.log('üìç Utilisation de l\'ordre de cr√©ation des points');
                
                // WARM-UP CRITIQUE : Forcer Leaflet √† se r√©veiller avant premi√®re capture
                // Sans √ßa, le premier point est mal centr√©
                console.log('üî• Initialisation Leaflet...');
                
                // Forcer un cycle complet de la carte
                const currentCenter = map.getCenter();
                const currentZoom = map.getZoom();
                
                // Faire un setView forc√©
                if (points.length > 0) {
                    map.setView([points[0].lat, points[0].lng], zoomLevel, { animate: false });
                    map.invalidateSize(true);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Revenir √† la vue normale
                    map.setView(currentCenter, currentZoom, { animate: false });
                }
                
                console.log('‚úÖ Leaflet initialis√©');
                
                let htmlReport = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Rapport ${currentProject.name}</title>
                        <style>
                            body { 
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                max-width: 1000px; 
                                margin: 40px auto; 
                                padding: 20px;
                                background: #f8fafc;
                            }
                            .container {
                                background: white;
                                padding: 40px;
                                border-radius: 12px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            }
                            h1 { 
                                color: #0f172a; 
                                border-bottom: 4px solid #f97316; 
                                padding-bottom: 15px;
                                margin-bottom: 30px;
                            }
                            .header { 
                                background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                                padding: 25px; 
                                border-radius: 10px; 
                                margin-bottom: 40px;
                                border-left: 4px solid #f97316;
                            }
                            .header h2 {
                                margin: 0 0 15px 0;
                                color: #0f172a;
                            }
                            .header p {
                                margin: 5px 0;
                                color: #64748b;
                            }
                            .overview-section {
                                background: #fef3c7;
                                padding: 25px;
                                border-radius: 10px;
                                margin-bottom: 40px;
                                border: 2px solid #f97316;
                            }
                            .overview-section h3 {
                                margin: 0 0 15px 0;
                                color: #92400e;
                            }
                            .overview-map {
                                width: 100%;
                                border-radius: 10px;
                                border: 3px solid white;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                                margin-top: 15px;
                            }
                            .point { 
                                background: white; 
                                border: 2px solid #e2e8f0; 
                                border-radius: 12px; 
                                padding: 25px; 
                                margin-bottom: 40px; 
                                page-break-inside: avoid;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                            }
                            .point-header {
                                display: flex;
                                justify-content: space-between;
                                align-items: start;
                                margin-bottom: 20px;
                                padding-bottom: 15px;
                                border-bottom: 2px solid #f1f5f9;
                            }
                            .point-number {
                                background: #f97316;
                                color: white;
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                display: inline-flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 18px;
                                margin-right: 15px;
                                box-shadow: 0 2px 8px rgba(249, 115, 22, 0.4);
                            }
                            .point-title { 
                                font-size: 22px; 
                                font-weight: bold; 
                                color: #0f172a;
                                flex: 1;
                            }
                            .badge { 
                                display: inline-block; 
                                padding: 6px 14px; 
                                border-radius: 8px; 
                                font-size: 13px; 
                                font-weight: bold;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            }
                            .badge-todo { background: #fef3c7; color: #92400e; }
                            .badge-progress { background: #dbeafe; color: #1e40af; }
                            .badge-done { background: #d1fae5; color: #065f46; }
                            .meta { 
                                color: #64748b; 
                                font-size: 14px; 
                                margin: 15px 0;
                                line-height: 1.8;
                            }
                            .gps-link {
                                color: #f97316;
                                text-decoration: none;
                                font-weight: 600;
                                padding: 4px 8px;
                                background: #fff7ed;
                                border-radius: 4px;
                                display: inline-block;
                                transition: all 0.2s;
                            }
                            .gps-link:hover {
                                background: #f97316;
                                color: white;
                                transform: translateY(-1px);
                            }
                            .status-history {
                                background: #f8fafc;
                                border-left: 4px solid #3b82f6;
                                padding: 16px 20px;
                                margin: 20px 0;
                                border-radius: 8px;
                            }
                            .status-history h4 {
                                color: #0f172a;
                                margin: 0 0 12px 0;
                                font-size: 16px;
                            }
                            .status-timeline {
                                position: relative;
                                padding-left: 30px;
                            }
                            .status-timeline::before {
                                content: '';
                                position: absolute;
                                left: 8px;
                                top: 8px;
                                bottom: 8px;
                                width: 2px;
                                background: #cbd5e1;
                            }
                            .status-entry {
                                position: relative;
                                padding: 8px 0;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                            }
                            .status-entry::before {
                                content: '';
                                position: absolute;
                                left: -22px;
                                width: 12px;
                                height: 12px;
                                border-radius: 50%;
                                background: white;
                                border: 3px solid;
                            }
                            .status-entry.status-todo::before {
                                border-color: #f59e0b;
                            }
                            .status-entry.status-progress::before {
                                border-color: #3b82f6;
                            }
                            .status-entry.status-done::before {
                                border-color: #10b981;
                            }
                            .status-entry-label {
                                font-weight: 600;
                                min-width: 100px;
                            }
                            .status-entry-date {
                                color: #64748b;
                                font-size: 13px;
                            }
                            .status-entry-user {
                                color: #94a3b8;
                                font-size: 12px;
                                font-style: italic;
                            }
                            .comment { 
                                margin: 20px 0; 
                                line-height: 1.8;
                                background: #f8fafc;
                                padding: 20px;
                                border-radius: 8px;
                                border-left: 4px solid #f97316;
                            }
                            .comment strong {
                                color: #0f172a;
                                display: block;
                                margin-bottom: 10px;
                            }
                            .images { 
                                display: grid; 
                                grid-template-columns: 1fr 1fr; 
                                gap: 20px; 
                                margin-top: 25px;
                            }
                            .image-container {
                                text-align: center;
                            }
                            .images img { 
                                width: 100%; 
                                border-radius: 10px; 
                                border: 2px solid #e2e8f0;
                                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                            }
                            .image-label { 
                                font-size: 13px; 
                                color: #64748b; 
                                margin-top: 8px;
                                font-weight: 600;
                            }
                            @media print {
                                body { background: white; }
                                .container { box-shadow: none; }
                                .point { page-break-inside: avoid; }
                                .gps-link { text-decoration: underline; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <h1>üèóÔ∏è VRDControl - Rapport de Suivi</h1>
                            <div class="header">
                                <h2>${currentProject.name}</h2>
                                <p><strong>üìÖ Date du rapport:</strong> ${new Date().toLocaleDateString('fr-FR', { 
                                    weekday: 'long',
                                    day: 'numeric', 
                                    month: 'long', 
                                    year: 'numeric' 
                                })}</p>
                                <p><strong>üìç Nombre de points:</strong> ${points.length}</p>
                `;

                const stats = getProjectStats(currentProject);
                htmlReport += `
                                <p><strong>üìä Statut global:</strong> 
                                    ${stats.todo} √† faire | 
                                    ${stats.progress} en cours | 
                                    ${stats.done} termin√©s
                                </p>
                            </div>
                `;

                // G√©n√©rer la carte g√©n√©rale avec tous les points
                console.log('üó∫Ô∏è G√©n√©ration de la carte g√©n√©rale...');
                const overviewMapImage = await captureOverviewMap(points, layerType);
                
                if (overviewMapImage) {
                    htmlReport += `
                        <div class="overview-section">
                            <h3>üó∫Ô∏è Vue d'ensemble - Tous les points</h3>
                            <p style="color: #92400e; margin: 10px 0;">
                                Localisation de tous les points de travaux sur la zone.
                            </p>
                            <img src="${overviewMapImage}" class="overview-map" alt="Carte g√©n√©rale avec tous les points">
                        </div>
                    `;
                }

                // Generate report for each point with images
                for (let i = 0; i < points.length; i++) {
                    // V√©rifier si l'utilisateur a annul√©
                    if (reportGenerationCancelled) {
                        console.log('‚ö†Ô∏è G√©n√©ration annul√©e par l\'utilisateur');
                        hideReportProgress();
                        alert('‚ùå G√©n√©ration du rapport annul√©e');
                        return;
                    }
                    
                    const point = points[i];
                    
                    const statusClass = point.status === 'done' ? 'badge-done' :
                                      point.status === 'progress' ? 'badge-progress' : 'badge-todo';
                    const statusText = point.status === 'done' ? '‚úì Termin√©' :
                                     point.status === 'progress' ? '‚è≥ En cours' : '‚è∏ √Ä faire';

                    console.log(`üìç G√©n√©ration du point ${point.number}/${points.length}: ${point.title}`);

                    // Capture map screenshot for this point with chosen layer and zoom
                    const mapImage = await captureMapForPoint(point, layerType, zoomLevel);
                    
                    // Lien Google Maps
                    const googleMapsLink = `https://www.google.com/maps?q=${point.lat},${point.lng}`;

                    htmlReport += `
                        <div class="point">
                            <div class="point-header">
                                <div style="display: flex; align-items: center; flex: 1;">
                                    <span class="point-number">${point.number}</span>
                                    <div class="point-title">${point.title}</div>
                                </div>
                                <span class="badge ${statusClass}">${statusText}</span>
                            </div>
                            <div class="meta">
                                üìç <strong>Adresse:</strong> ${point.address}<br>
                                üìÖ <strong>Date:</strong> ${new Date(point.createdAt).toLocaleString('fr-FR')}<br>
                                üåê <strong>GPS:</strong> <a href="${googleMapsLink}" target="_blank" class="gps-link">üìç ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)} - Ouvrir dans Maps</a>
                            </div>
                            ${point.statusHistory && point.statusHistory.length > 0 ? `
                                <div class="status-history">
                                    <h4>üìä Historique du statut</h4>
                                    <div class="status-timeline">
                                        ${point.statusHistory.map(entry => {
                                            const statusLabel = entry.status === 'done' ? '‚úÖ Termin√©' :
                                                              entry.status === 'progress' ? '‚è≥ En cours' : '‚è∏Ô∏è √Ä faire';
                                            const statusClass = entry.status;
                                            const entryDate = new Date(entry.date);
                                            return `
                                                <div class="status-entry status-${statusClass}">
                                                    <span class="status-entry-label">${statusLabel}</span>
                                                    <span class="status-entry-date">le ${entryDate.toLocaleDateString('fr-FR', { 
                                                        day: '2-digit', 
                                                        month: '2-digit', 
                                                        year: 'numeric' 
                                                    })} √† ${entryDate.toLocaleTimeString('fr-FR', { 
                                                        hour: '2-digit', 
                                                        minute: '2-digit' 
                                                    })}</span>
                                                    <span class="status-entry-user">par ${entry.user}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div class="comment">
                                <strong>üìù Travaux √† effectuer:</strong>
                                ${point.comment.replace(/\n/g, '<br>')}
                            </div>
                            <div class="images">
                    `;

                    if (point.photo) {
                        htmlReport += `
                                <div class="image-container">
                                    <img src="${point.photo}" alt="Photo du point ${i + 1}">
                                    <div class="image-label">üì∑ Photo sur site</div>
                                </div>
                        `;
                    }

                    if (mapImage) {
                        htmlReport += `
                                <div class="image-container">
                                    <img src="${mapImage}" alt="Localisation du point ${i + 1}">
                                    <div class="image-label">üó∫Ô∏è Localisation pr√©cise</div>
                                </div>
                        `;
                    }

                    if (!point.photo && !mapImage) {
                        htmlReport += `
                                <div class="image-container" style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #94a3b8;">
                                    Aucune image disponible pour ce point
                                </div>
                        `;
                    }

                    htmlReport += `
                            </div>
                        </div>
                    `;
                }

                htmlReport += `
                        </div>
                    </body>
                    </html>
                `;

                // Download HTML report
                const blob = new Blob([htmlReport], { type: 'text/html;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `VRDControl_${currentProject.name}_${Date.now()}.html`);
                link.click();

                alert('‚úÖ Rapport HTML g√©n√©r√© avec succ√®s !\n\nLe fichier contient les photos et les captures de carte.');

            } catch (error) {
                console.error('Erreur g√©n√©ration rapport:', error);
                alert('‚ùå Erreur lors de la g√©n√©ration du rapport: ' + error.message);
            } finally {
                // Restore button and remove cancel button
                button.textContent = originalText;
                button.disabled = false;
                
                // Remove cancel button if it exists
                const cancelBtn = button.parentElement.querySelector('.btn-danger');
                if (cancelBtn && cancelBtn.textContent.includes('Annul')) {
                    cancelBtn.remove();
                }
            }
        }

        async function generateExcelReport() {
            // Create CSV content
            let csv = 'Titre,Adresse,Commentaire,Statut,Coordonn√©es,Date de cr√©ation\n';
            
            currentProject.points.forEach(point => {
                const status = point.status === 'done' ? 'Termin√©' :
                             point.status === 'progress' ? 'En cours' : '√Ä faire';
                
                csv += `"${point.title}","${point.address}","${point.comment}","${status}","${point.lat}, ${point.lng}","${new Date(point.createdAt).toLocaleString('fr-FR')}"\n`;
            });

            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `VRDControl_${currentProject.name}_rapport_${Date.now()}.csv`);
            link.click();
        }

        function generateTextReport() {
            let report = `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            report += `RAPPORT DE SUIVI DE CHANTIER - VRDControl\n`;
            report += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            report += `Projet: ${currentProject.name}\n`;
            report += `Date: ${new Date().toLocaleDateString('fr-FR')}\n`;
            report += `Nombre de points: ${currentProject.points.length}\n\n`;

            const stats = getProjectStats(currentProject);
            report += `Statut global:\n`;
            report += `  - √Ä faire: ${stats.todo}\n`;
            report += `  - En cours: ${stats.progress}\n`;
            report += `  - Termin√©: ${stats.done}\n`;
            report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

            currentProject.points.forEach((point, index) => {
                const status = point.status === 'done' ? 'TERMIN√â ‚úì' :
                             point.status === 'progress' ? 'EN COURS ‚è≥' : '√Ä FAIRE ‚è∏';
                
                report += `POINT ${index + 1}: ${point.title}\n`;
                report += `${'‚îÄ'.repeat(55)}\n`;
                report += `Statut: ${status}\n`;
                report += `Adresse: ${point.address}\n`;
                report += `Coordonn√©es: ${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}\n`;
                report += `Date: ${new Date(point.createdAt).toLocaleString('fr-FR')}\n\n`;
                report += `Commentaire:\n${point.comment}\n`;
                if (point.photo) {
                    report += `\n[Photo disponible dans l'application]\n`;
                }
                report += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            });

            // Download text file
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `VRDControl_${currentProject.name}_rapport_${Date.now()}.txt`);
            link.click();
        }

        // Archive project
        function archiveProject() {
            if (!currentProject) return;
            document.getElementById('archiveProjectName').textContent = currentProject.name;
            document.getElementById('archiveModal').classList.add('active');
        }

        // Delete current project permanently
        // Delete project from sidebar (by ID)
        async function deleteProjectConfirm(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const confirmDelete = confirm(
                `‚ö†Ô∏è SUPPRIMER D√âFINITIVEMENT LE PROJET ?\n\n` +
                `Projet : ${project.name}\n` +
                `Points : ${project.points.length}\n\n` +
                `Cette action est IRR√âVERSIBLE !\n` +
                `Toutes les donn√©es seront perdues.\n\n` +
                `Voulez-vous continuer ?`
            );
            
            if (!confirmDelete) return;
            
            // Double confirmation
            const finalConfirm = prompt(
                `Pour confirmer la suppression, tapez le nom du projet :\n"${project.name}"`
            );
            
            if (finalConfirm !== project.name) {
                alert('‚ùå Nom incorrect. Suppression annul√©e.');
                return;
            }
            
            // Supprimer du storage
            await deleteProjectFromStorage(project.id);
            projects = projects.filter(p => p.id !== project.id);
            
            // Si c'est le projet actuel, d√©selectionner
            if (currentProject?.id === project.id) {
                currentProject = null;
                document.getElementById('currentProjectName').textContent = 'S√©lectionnez un projet';
                document.getElementById('projectTools').style.display = 'none';
                clearMap();
            }
            
            // Rafra√Æchir liste
            renderProjects();
            
            alert('‚úÖ Projet supprim√© avec succ√®s');
        }

        // Delete current project from toolbar
        async function deleteCurrentProject() {
            if (!currentProject) return;
            
            const confirmDelete = confirm(
                `‚ö†Ô∏è SUPPRIMER D√âFINITIVEMENT LE PROJET ?\n\n` +
                `Projet : ${currentProject.name}\n` +
                `Points : ${currentProject.points.length}\n\n` +
                `Cette action est IRR√âVERSIBLE !\n` +
                `Toutes les donn√©es seront perdues.\n\n` +
                `Voulez-vous continuer ?`
            );
            
            if (!confirmDelete) return;
            
            // Double confirmation pour √©viter erreurs
            const finalConfirm = prompt(
                `Pour confirmer la suppression, tapez le nom du projet :\n"${currentProject.name}"`
            );
            
            if (finalConfirm !== currentProject.name) {
                alert('‚ùå Nom incorrect. Suppression annul√©e.');
                return;
            }
            
            // Supprimer du storage
            await deleteProjectFromStorage(currentProject.id);
            projects = projects.filter(p => p.id !== currentProject.id);
            
            // R√©initialiser interface
            currentProject = null;
            document.getElementById('currentProjectName').textContent = 'S√©lectionnez un projet';
            document.getElementById('projectTools').style.display = 'none';
            
            // Nettoyer carte
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            // Rafra√Æchir sidebar
            renderProjects();
            hidePointsPanel();
            
            alert('‚úÖ Projet supprim√© d√©finitivement');
        }

        async function confirmArchive() {
            const duration = parseInt(document.getElementById('archiveDuration').value);
            
            const archiveData = {
                ...currentProject,
                archivedAt: new Date().toISOString(),
                deleteAfter: new Date(Date.now() + duration * 30 * 24 * 60 * 60 * 1000).toISOString() // duration en mois
            };

            // Sauvegarder dans les archives
            if (!window.storage) {
                const archives = JSON.parse(localStorage.getItem('vrd_archives') || '[]');
                archives.push(archiveData);
                localStorage.setItem('vrd_archives', JSON.stringify(archives));
            } else {
                try {
                    await window.storage.set(`archive:${archiveData.id}`, JSON.stringify(archiveData));
                } catch (error) {
                    const archives = JSON.parse(localStorage.getItem('vrd_archives') || '[]');
                    archives.push(archiveData);
                    localStorage.setItem('vrd_archives', JSON.stringify(archives));
                }
            }

            // Supprimer du projet actif
            await deleteProjectFromStorage(currentProject.id);
            projects = projects.filter(p => p.id !== currentProject.id);
            
            currentProject = null;
            document.getElementById('currentProjectName').textContent = 'S√©lectionnez un projet';
            document.getElementById('projectTools').style.display = 'none';
            
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            closeModal('archiveModal');
            renderProjects();
            hidePointsPanel();
            
            alert(`‚úÖ Projet archiv√© pour ${duration} mois`);
            await loadArchives();
        }

        // Archives management
        let archives = [];

        async function loadArchives() {
            if (!window.storage) {
                archives = JSON.parse(localStorage.getItem('vrd_archives') || '[]');
            } else {
                try {
                    const result = await window.storage.list('archive:');
                    if (result && result.keys) {
                        archives = [];
                        for (const key of result.keys) {
                            const data = await window.storage.get(key);
                            if (data) {
                                archives.push(JSON.parse(data.value));
                            }
                        }
                    }
                } catch (error) {
                    archives = JSON.parse(localStorage.getItem('vrd_archives') || '[]');
                }
            }
            updateArchiveCount();
        }

        function updateArchiveCount() {
            document.getElementById('archiveCount').textContent = archives.length;
        }

        async function cleanExpiredArchives() {
            const now = new Date();
            const expiredArchives = archives.filter(a => new Date(a.deleteAfter) < now);
            
            for (const archive of expiredArchives) {
                if (!window.storage) {
                    archives = archives.filter(a => a.id !== archive.id);
                    localStorage.setItem('vrd_archives', JSON.stringify(archives));
                } else {
                    try {
                        await window.storage.delete(`archive:${archive.id}`);
                    } catch (error) {
                        archives = archives.filter(a => a.id !== archive.id);
                        localStorage.setItem('vrd_archives', JSON.stringify(archives));
                    }
                }
            }
            
            if (expiredArchives.length > 0) {
                await loadArchives();
                console.log(`${expiredArchives.length} archives expir√©es supprim√©es`);
            }
        }

        function showArchivesModal() {
            const archivesList = document.getElementById('archivesList');
            
            if (archives.length === 0) {
                archivesList.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Aucune archive</p>';
            } else {
                archivesList.innerHTML = archives.map(archive => {
                    const archivedDate = new Date(archive.archivedAt).toLocaleDateString('fr-FR');
                    const deleteDate = new Date(archive.deleteAfter).toLocaleDateString('fr-FR');
                    const daysLeft = Math.ceil((new Date(archive.deleteAfter) - new Date()) / (1000 * 60 * 60 * 24));
                    
                    return `
                        <div style="background: var(--bg); border: 2px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">${archive.name}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">
                                        üìÖ Archiv√© le ${archivedDate}<br>
                                        üóëÔ∏è Suppression le ${deleteDate} (dans ${daysLeft} jours)<br>
                                        üìç ${archive.points.length} points
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success btn-sm" onclick="restoreArchive('${archive.id}')">
                                    ‚Ü©Ô∏è Restaurer
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteArchive('${archive.id}')">
                                    üóëÔ∏è Supprimer
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('archivesModal').classList.add('active');
        }

        async function restoreArchive(archiveId) {
            const archive = archives.find(a => a.id === archiveId);
            if (!archive) return;
            
            if (!confirm(`Restaurer le projet "${archive.name}" dans les projets actifs ?`)) {
                return;
            }

            // Supprimer les m√©tadonn√©es d'archive
            delete archive.archivedAt;
            delete archive.deleteAfter;

            // Ajouter aux projets actifs
            projects.push(archive);
            await saveProject(archive);

            // Supprimer des archives
            if (!window.storage) {
                archives = archives.filter(a => a.id !== archiveId);
                localStorage.setItem('vrd_archives', JSON.stringify(archives));
            } else {
                try {
                    await window.storage.delete(`archive:${archiveId}`);
                } catch (error) {
                    archives = archives.filter(a => a.id !== archiveId);
                    localStorage.setItem('vrd_archives', JSON.stringify(archives));
                }
            }

            await loadArchives();
            renderProjects();
            closeModal('archivesModal');
            alert('‚úÖ Projet restaur√© avec succ√®s !');
        }

        async function deleteArchive(archiveId) {
            const archive = archives.find(a => a.id === archiveId);
            if (!archive) return;
            
            if (!confirm(`Supprimer d√©finitivement l'archive "${archive.name}" ?\nCette action est irr√©versible.`)) {
                return;
            }

            if (!window.storage) {
                archives = archives.filter(a => a.id !== archiveId);
                localStorage.setItem('vrd_archives', JSON.stringify(archives));
            } else {
                try {
                    await window.storage.delete(`archive:${archiveId}`);
                } catch (error) {
                    archives = archives.filter(a => a.id !== archiveId);
                    localStorage.setItem('vrd_archives', JSON.stringify(archives));
                }
            }

            await loadArchives();
            showArchivesModal(); // Refresh the list
            alert('üóëÔ∏è Archive supprim√©e d√©finitivement');
        }

        // Modal helpers
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            // Remove temporary marker when closing new point modal
            if (modalId === 'newPointModal' && currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
                currentLatLng = null;
            }
        }

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', initApp);

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Geolocation function for smartphones
        function centerOnMyLocation() {
            // V√©rifier HTTPS (requis pour g√©olocalisation sur mobile)
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert(
                    '‚ö†Ô∏è HTTPS REQUIS POUR LA G√âOLOCALISATION\n\n' +
                    'Votre navigateur bloque la g√©olocalisation car le site n\'est pas en HTTPS.\n\n' +
                    'üìå SOLUTIONS TEMPORAIRES :\n' +
                    '1. Cliquez directement sur la carte pour placer un point\n' +
                    '2. Utilisez la recherche d\'adresse\n\n' +
                    '‚úÖ SOLUTION PERMANENTE :\n' +
                    'D√©ployez VRDControl sur :\n' +
                    '‚Ä¢ GitHub Pages (gratuit, HTTPS auto)\n' +
                    '‚Ä¢ Vercel (gratuit, HTTPS auto)\n' +
                    '‚Ä¢ Votre serveur avec certificat SSL'
                );
                return;
            }

            if (!navigator.geolocation) {
                alert('‚ùå La g√©olocalisation n\'est pas support√©e par votre navigateur');
                return;
            }

            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'üîç Localisation...';
            button.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Centrer la carte sur la position
                    map.setView([lat, lng], 18);
                    
                    // Ajouter un marqueur temporaire "Vous √™tes ici"
                    const myLocationIcon = L.divIcon({
                        className: 'my-location-marker',
                        html: `
                            <div style="
                                background: #3b82f6;
                                color: white;
                                width: 44px;
                                height: 44px;
                                border-radius: 50%;
                                border: 4px solid white;
                                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 24px;
                                animation: pulse 2s infinite;
                            ">üìç</div>
                        `,
                        iconSize: [44, 44],
                        iconAnchor: [22, 22]
                    });
                    
                    const myMarker = L.marker([lat, lng], { icon: myLocationIcon })
                        .addTo(map)
                        .bindPopup('üìç Vous √™tes ici<br><small>Pr√©cision: ¬±' + position.coords.accuracy.toFixed(0) + 'm</small>')
                        .openPopup();
                    
                    // Retirer le marqueur apr√®s 10 secondes
                    setTimeout(() => {
                        map.removeLayer(myMarker);
                    }, 10000);
                    
                    button.textContent = originalText;
                    button.disabled = false;
                },
                (error) => {
                    let errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Autorisation de g√©olocalisation refus√©e';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Position indisponible';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'D√©lai de localisation d√©pass√©';
                            break;
                        default:
                            errorMsg = 'Erreur de g√©olocalisation';
                    }
                    alert('‚ùå ' + errorMsg);
                    button.textContent = originalText;
                    button.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('mobile-open') && 
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });
    </script>
</body>
</html>